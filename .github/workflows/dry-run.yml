name: Dry Run

on:
  # Everyday at 00:00 UTC
  schedule:
    - cron: '0 0 * * *'
  # Manual triggers
  workflow_dispatch:
    inputs:
      upload_apk:
        description: 'Upload APK to GitHub Actions'
        required: false
        default: 'false'
      repo_branch:
        description: 'Repository branch to build from'
        required: false
        default: 'development'

env:
  JAVA_VERSION: 21
  JAVA_DISTRO: 'temurin'

jobs:
  build-app:
    runs-on: macos-latest
    permissions:
      contents: write
      discussions: write
    env:
      COMMIT_COUNT: 0
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          repository: 'ArthurKun21/FGA-Preview'
          token: ${{ secrets.PAT }}
          ref: ${{ github.event.inputs.repo_branch || 'development' }}

      - name: Prepare build
        run: |
          commit_count=$(git rev-list --count HEAD)
          echo "COMMIT_COUNT=$commit_count" >> $GITHUB_ENV

      - name: Validate Gradle Wrapper
        uses: gradle/actions/wrapper-validation@v5
      
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRO }}
  
      - name: Set up gradle
        uses: gradle/actions/setup-gradle@v5
    
      - name: Build Android Package
        run: |
          ./gradlew assembleCi --parallel
      
      - name: Clean up build artifacts
        run: |
          cp app/build/outputs/apk/ci/app-universal-ci.apk fga-ci-${{ env.COMMIT_COUNT }}.apk

          cp app/build/outputs/apk/ci/app-arm64-v8a-ci.apk fga-ci-arm64-v8a-${{ env.COMMIT_COUNT }}.apk
          cp app/build/outputs/apk/ci/app-armeabi-v7a-ci.apk fga-ci-armeabi-v7a-${{ env.COMMIT_COUNT }}.apk
          cp app/build/outputs/apk/ci/app-x86_64-ci.apk fga-ci-x86_64-${{ env.COMMIT_COUNT }}.apk
          cp app/build/outputs/apk/ci/app-x86-ci.apk fga-ci-x86-${{ env.COMMIT_COUNT }}.apk

          cp app/build/outputs/mapping/ci/mapping.txt fga-ci-${{ env.COMMIT_COUNT }}-mapping.txt
      
      - name: Upload Mapping
        if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.upload_apk == 'true' || github.event.inputs.upload_apk == true) }}
        uses: actions/upload-artifact@v6
        with:
          name: fga-ci-${{ env.COMMIT_COUNT }}-mapping
          path: fga-ci-${{ env.COMMIT_COUNT }}-mapping.txt
      
      - name: Upload APK
        if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.upload_apk == 'true' || github.event.inputs.upload_apk == true) }}
        uses: actions/upload-artifact@v6
        with:
          name: fga-ci-${{ env.COMMIT_COUNT }}-apk
          path: fga-ci-${{ env.COMMIT_COUNT }}.apk
      
      - name: Upload APK (arm64-v8a)
        if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.upload_apk == 'true' || github.event.inputs.upload_apk == true) }}
        uses: actions/upload-artifact@v6
        with:
          name: fga-ci-arm64-v8a-${{ env.COMMIT_COUNT }}-apk
          path: fga-ci-arm64-v8a-${{ env.COMMIT_COUNT }}.apk
      
      - name: Upload APK (armeabi-v7a)
        if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.upload_apk == 'true' || github.event.inputs.upload_apk == true) }}
        uses: actions/upload-artifact@v6
        with:
          name: fga-ci-armeabi-v7a-${{ env.COMMIT_COUNT }}-apk
          path: fga-ci-armeabi-v7a-${{ env.COMMIT_COUNT }}.apk
      
      - name: Upload APK (x86_64)
        if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.upload_apk == 'true' || github.event.inputs.upload_apk == true) }}
        uses: actions/upload-artifact@v6
        with:
          name: fga-ci-x86_64-${{ env.COMMIT_COUNT }}-apk
          path: fga-ci-x86_64-${{ env.COMMIT_COUNT }}.apk
      
      - name: Upload APK (x86)
        if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.upload_apk == 'true' || github.event.inputs.upload_apk == true) }}
        uses: actions/upload-artifact@v6
        with:
          name: fga-ci-x86-${{ env.COMMIT_COUNT }}-apk
          path: fga-ci-x86-${{ env.COMMIT_COUNT }}.apk

